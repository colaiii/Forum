<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}校园网匿名论坛{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20250128-4">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <header class="header">
        <div class="container">
            <!-- 移动端菜单按钮（集成到header左侧） -->
            <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="切换菜单">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <h1 class="logo">
                <a href="{{ url_for('main.index') }}">🍪 校园网匿名论坛</a>
            </h1>
            
            <nav class="nav">
                <a href="{{ url_for('main.index') }}" class="nav-link">首页</a>
                <button class="nav-link" onclick="showRulesModal()" style="background: none; border: none; color: inherit; cursor: pointer;">规则</button>
                <button class="nav-link" onclick="showCookieManager()" style="background: none; border: none; color: inherit; cursor: pointer;">🍪 饼干管理</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- 饼干管理弹窗 -->
    <div id="cookieManagerModal" class="modal" onclick="hideCookieManager()">
        <div class="modal-content cookie-manager-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🍪 饼干管理</h2>
                <span class="modal-close" onclick="hideCookieManager()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 当前饼干 -->
                <div class="current-cookie-section">
                    <h3>当前饼干</h3>
                    <div class="current-cookie-display">
                        <div class="cookie-item current">
                            <div class="cookie-info">
                                <div class="cookie-id" id="currentCookieId">ID:loading...</div>
                                <div class="cookie-color" id="currentCookieColor"></div>
                                <div class="cookie-status">当前使用中</div>
                            </div>
                            <div class="cookie-actions">
                                <button class="btn btn-secondary btn-small" onclick="saveCookie()" id="saveCookieBtn">收藏此饼干</button>
                                <button class="btn btn-secondary btn-small" onclick="newCookie()" id="newCookieBtn">生成新饼干</button>
                            </div>
                            <div class="cookie-limits" id="cookieLimits">
                                <div class="limit-info">
                                    <span class="limit-label">24小时生成次数：</span>
                                    <span class="limit-value" id="generationCount">0/3</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收藏的饼干 -->
                <div class="saved-cookies-section">
                    <h3>收藏的饼干 <span class="cookie-count" id="savedCookieCount">(0/3)</span></h3>
                    <div class="saved-cookies-list" id="savedCookiesList">
                        <div class="empty-message">暂无收藏的饼干</div>
                    </div>
                </div>

                <!-- 添加饼干表单 -->
                <div class="add-cookie-section">
                    <h3>导入饼干</h3>
                    <div class="security-notice">
                        <p><strong>🔒 安全提示：</strong>只能导入已在系统中注册且有效的饼干ID。</p>
                        <p><strong>⏱️ 速率限制：</strong>为防止暴力破解，每分钟最多尝试3次导入。</p>
                    </div>
                    <div class="form-group">
                        <label for="importCookieId">饼干ID（16位）：</label>
                        <input type="text" id="importCookieId" placeholder="输入16位饼干ID" maxlength="16">
                    </div>
                    <div class="form-group">
                        <label for="importCookieName">备注名称：</label>
                        <input type="text" id="importCookieName" placeholder="给这个饼干起个名字">
                    </div>
                    <div class="import-limits" id="importLimits">
                        <div class="limit-info">
                            <span class="limit-label">导入尝试次数：加载中...</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="importCookie()">验证并导入</button>
                </div>

                <!-- 帮助说明 -->
                <div class="cookie-help">
                    <h4>💡 使用说明</h4>
                    <ul>
                        <li><strong>收藏饼干</strong>：点击"收藏此饼干"将当前饼干保存到本地</li>
                        <li><strong>切换饼干</strong>：点击收藏列表中的"使用"按钮切换身份</li>
                        <li><strong>生成新饼干</strong>：获得全新的匿名身份</li>
                        <li><strong>导入饼干</strong>：手动输入已知的饼干ID进行恢复（仅限已注册饼干）</li>
                        <li><strong>数据安全</strong>：所有饼干数据仅保存在您的浏览器本地</li>
                        <li><strong>注意事项</strong>：清除浏览器数据会丢失收藏的饼干</li>
                    </ul>
                    
                    <h4>⚠️ 使用限制</h4>
                    <ul>
                        <li><strong>收藏限制</strong>：每个用户最多只能收藏3个饼干身份</li>
                        <li><strong>生成限制</strong>：24小时内最多只能生成3个新饼干</li>
                        <li><strong>自动清理</strong>：生成记录会在24小时后自动清除</li>
                        <li><strong>安全验证</strong>：导入饼干需要验证是否在系统中注册</li>
                        <li><strong>有效期追踪</strong>：所有饼干都有明确的创建和过期时间</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义确认弹窗 -->
    <div id="customConfirmModal" class="modal" style="display: none;">
        <div class="modal-content custom-confirm-modal" onclick="event.stopPropagation()">
            <div class="confirm-modal-header">
                <div class="confirm-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 id="confirmTitle">确认操作</h3>
            </div>
            <div class="confirm-modal-body">
                <p id="confirmMessage">确定要执行此操作吗？</p>
                <div class="confirm-actions">
                    <button id="confirmCancel" class="btn-modal btn-cancel">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="m15 9-6 6m0-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        取消
                    </button>
                    <button id="confirmOk" class="btn-modal btn-confirm">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        确定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义输入弹窗 -->
    <div id="customPromptModal" class="modal" style="display: none;">
        <div class="modal-content custom-prompt-modal" onclick="event.stopPropagation()">
            <div class="prompt-modal-header">
                <div class="prompt-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 id="promptTitle">输入信息</h3>
            </div>
            <div class="prompt-modal-body">
                <p id="promptMessage">请输入：</p>
                <input type="text" id="promptInput" class="prompt-input" placeholder="">
                <div class="prompt-actions">
                    <button id="promptCancel" class="btn-modal btn-cancel">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="m15 9-6 6m0-6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        取消
                    </button>
                    <button id="promptOk" class="btn-modal btn-confirm">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        确定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 规则弹窗 -->
    <div id="rulesModal" class="modal" onclick="hideRulesModal()">
        <div class="modal-content rules-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>📋 论坛规则</h2>
                <span class="modal-close" onclick="hideRulesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="rules-section">
                    <h3>🍪 饼干匿名系统</h3>
                    <ul>
                        <li><strong>自动分配</strong>：首次访问自动获得16位匿名ID（饼干）</li>
                        <li><strong>有效期</strong>：默认7天</li>
                        <li><strong>一致性</strong>：同一饼干在所有串中保持统一标识</li>
                        <li><strong>隐私保护</strong>：基于时间戳生成，不记录真实身份信息</li>
                        <li><strong>视觉区分</strong>：不同饼干显示不同颜色，便于识别</li>
                        <li><strong>安全机制</strong>：定期更换，防止长期追踪和滥用</li>
                        <li><strong>收藏管理</strong>：可保存最多3个饼干身份，随时切换使用</li>
                        <li><strong>本地存储</strong>：收藏的饼干仅保存在浏览器本地，保护隐私</li>
                        <li><strong>生成限制</strong>：24小时内最多生成3个新饼干，防止滥用</li>
                        <li><strong>导入限制</strong>：每分钟最多尝试3次导入，防止暴力破解</li>
                        <li><strong>安全验证</strong>：只能导入已在系统中注册且有效的饼干ID</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h3>📝 发串与内容规范</h3>
                    <ul>
                        <li><strong>标题要求</strong>：1-100字符，简明扼要，禁止标题党</li>
                        <li><strong>内容格式</strong>：支持Markdown语法，包括代码、表格、列表等</li>
                        <li><strong>图片上传</strong>：支持PNG/JPG/GIF/WebP，单文件最大16MB</li>
                        <li><strong>内容质量</strong>：鼓励有价值的讨论，禁止无意义灌水</li>
                        <li><strong>校园相关</strong>：优先讨论校园生活、学习、社交等话题</li>
                        <li><strong>频率限制</strong>：同一饼干1分钟内最多发3串，防止刷屏</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h3>💬 回复与互动规则</h3>
                    <ul>
                        <li><strong>友善交流</strong>：理性讨论，尊重不同观点</li>
                        <li><strong>主题相关</strong>：回复内容应与串主题相关</li>
                        <li><strong>图文并茂</strong>：支持上传图片丰富回复内容</li>
                        <li><strong>频率限制</strong>：同一饼干1分钟内最多回复5次，防止刷屏</li>
                        <li><strong>建设性回复</strong>：鼓励有意义的补充和讨论</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h3>🔍 搜索功能使用</h3>
                    <ul>
                        <li><strong>搜索入口</strong>：主页搜索框或导航栏"搜索"链接</li>
                        <li><strong>全部搜索</strong>：同时搜索串标题和内容中的关键词</li>
                        <li><strong>精确搜索</strong>：选择"仅标题"或"仅内容"进行精确搜索</li>
                    </ul>
                </div>
                
                <div class="rules-section">
                    <h3>🎓 校园论坛特色</h3>
                    <ul>
                        <li><strong>学术讨论</strong>：课程交流、学习心得、考试经验</li>
                        <li><strong>校园生活</strong>：食堂评价、活动分享、社团交流</li>
                        <li><strong>资源分享</strong>：学习资料、软件推荐、生活攻略</li>
                        <li><strong>求助互助</strong>：学习困难、生活问题、心理疏导</li>
                        <li><strong>匿名倾诉</strong>：校园压力、人际关系、情感困扰</li>
                        <li><strong>建议反馈</strong>：校园设施、管理制度、论坛功能</li>
                    </ul>
                </div>

                <div class="rules-section">
                    <h3>🚫 严格禁止的行为</h3>
                    <ul>
                        <li><strong>违法内容</strong>：违法、暴力、恐怖主义等危险内容</li>
                        <li><strong>不良信息</strong>：色情、赌博、诈骗、毒品等有害信息</li>
                        <li><strong>恶意行为</strong>：人身攻击、恶意诽谤、网络霸凌</li>
                        <li><strong>隐私泄露</strong>：公开他人个人信息、照片、联系方式</li>
                        <li><strong>商业广告</strong>：未经允许的商业推广、营销活动</li>
                        <li><strong>技术破坏</strong>：恶意脚本、病毒链接、服务器攻击</li>
                        <li><strong>虚假信息</strong>：故意传播谣言、假消息、误导信息</li>
                        <li><strong>恶意搜索</strong>：频繁无意义搜索，影响系统性能</li>
                        <li><strong>饼干滥用</strong>：恶意尝试导入他人饼干，暴力破解</li>
                    </ul>
                </div>
                

                <div class="rules-section">
                    <h3>📱 Markdown语法指南</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <p><strong>文本格式：</strong></p>
                        <code>**粗体** *斜体* `代码` ~~删除线~~</code>
                        <p style="margin-top: 10px;"><strong>列表和引用：</strong></p>
                        <code>- 列表项<br/>> 引用文本</code>
                        <p style="margin-top: 10px;"><strong>链接和图片：</strong></p>
                        <code>[链接文字](网址)<br/>![图片描述](图片链接)</code>
                        <p style="margin-top: 10px;"><strong>代码块：</strong></p>
                        <code>```语言<br/>代码内容<br/>```</code>
                    </div>
                </div>
                
                <div class="rules-footer">
                    <p><strong>🎯 论坛愿景</strong></p>
                    <p>校园网匿名论坛致力于为师生提供一个安全、自由、高质量的交流平台。我们相信匿名机制能够鼓励真实表达，促进开放讨论，同时也需要每位用户的自律和责任心来维护社区秩序。</p>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">规则最后更新：2025年8月 |  解释权归论坛管理团队所有</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 校园网匿名论坛 | 请文明发言</p>
            <p class="footer-tip">饼干系统：每个用户自动分配临时ID，有效期7天</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/app.js') }}?v=20250128-8"></script>
    
    <script>
    // 确保所有弹窗点击遮罩层时也能恢复按钮状态
    document.addEventListener('DOMContentLoaded', function() {
        // 为所有模态框添加点击遮罩层关闭功能
        const modals = ['rulesModal', 'cookieManagerModal', 'imageModal', 'customConfirmModal', 'customPromptModal'];
        
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        // 恢复移动端按钮状态
                        if (typeof restoreMenuButton === 'function') {
                            restoreMenuButton();
                        }
                    }
                });
            }
        });
    });
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html> 