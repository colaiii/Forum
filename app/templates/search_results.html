{% extends "base.html" %}

{% block title %}æœç´¢ç»“æœ - æ ¡å›­ç½‘åŒ¿åè®ºå›{% endblock %}

{% block content %}
<div class="forum-header">
    <h2>ğŸ” æœç´¢ç»“æœ</h2>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
</div>

<!-- æœç´¢æ¡† -->
<div class="search-section">
    <form action="{{ url_for('main.search') }}" method="GET" class="search-form">
        <div class="search-input-wrapper">
            <input type="text" name="q" value="{{ query }}" 
                   placeholder="æœç´¢ä¸²æ ‡é¢˜ã€å†…å®¹..." class="search-input" required>
            <button type="submit" class="search-btn">ğŸ” æœç´¢</button>
        </div>
        <div class="search-options">
            <label class="search-option">
                <input type="radio" name="type" value="all" {{ 'checked' if search_type == 'all' else '' }}>
                <span>å…¨éƒ¨</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="title" {{ 'checked' if search_type == 'title' else '' }}>
                <span>ä»…æ ‡é¢˜</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="content" {{ 'checked' if search_type == 'content' else '' }}>
                <span>ä»…å†…å®¹</span>
            </label>
        </div>
    </form>
</div>

<!-- æœç´¢ç»“æœç»Ÿè®¡ -->
{% if query %}
<div class="search-stats">
    <p class="search-info">
        æœç´¢ "<strong>{{ query }}</strong>" 
        {% if search_type == 'title' %}(ä»…æ ‡é¢˜)
        {% elif search_type == 'content' %}(ä»…å†…å®¹)
        {% else %}(å…¨éƒ¨)
        {% endif %}
        {% if results %}
            ï¼Œå…±æ‰¾åˆ° <strong>{{ results.total }}</strong> ä¸ªç»“æœ
        {% else %}
            ï¼Œæœªæ‰¾åˆ°ç›¸å…³ç»“æœ
        {% endif %}
    </p>
</div>
{% endif %}

<!-- æœç´¢ç»“æœåˆ—è¡¨ -->
{% if results and results.items %}
<div class="search-results-section">
    {% for thread in results.items %}
    <div class="thread-item search-result">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
            {% if thread.is_pinned %}
            <span class="thread-pin">ğŸ“Œ</span>
            {% endif %}
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at|localtime }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}">
                {{ thread.title|highlight_search(query) if query else thread.title }}
            </a>
        </h4>
        <div class="thread-content">
            {% if thread.get_image_urls() %}
            <div class="thread-images">
                {% for image_url in thread.get_image_urls()[:2] %}
                <div class="thread-image">
                    <img src="{{ image_url }}" alt="å›¾ç‰‡" onclick="showImageModal(this.src)">
                </div>
                {% endfor %}
                {% if thread.get_image_urls()|length > 2 %}
                <div class="more-images">+{{ thread.get_image_urls()|length - 2 }}å¼ å›¾ç‰‡</div>
                {% endif %}
            </div>
            {% endif %}
            <div class="markdown-preview search-preview">
                {{ (thread.content[:300] + '...' if thread.content|length > 300 else thread.content)|highlight_search(query)|markdown if query else (thread.content[:300] + '...' if thread.content|length > 300 else thread.content)|markdown }}
            </div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">ğŸ’¬ {{ thread.reply_count }}</span>
            <span class="last-reply">æœ€åå›å¤: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- åˆ†é¡µ -->
{% if results.pages > 1 %}
<div class="pagination">
    {% if results.has_prev %}
        <a href="{{ url_for('main.search', q=query, type=search_type, page=results.prev_num) }}" class="page-link">&laquo; ä¸Šä¸€é¡µ</a>
    {% endif %}
    
    {% for page_num in results.iter_pages() %}
        {% if page_num %}
            {% if page_num != results.page %}
                <a href="{{ url_for('main.search', q=query, type=search_type, page=page_num) }}" class="page-link">{{ page_num }}</a>
            {% else %}
                <span class="page-link current">{{ page_num }}</span>
            {% endif %}
        {% else %}
            <span class="page-link">...</span>
        {% endif %}
    {% endfor %}
    
    {% if results.has_next %}
        <a href="{{ url_for('main.search', q=query, type=search_type, page=results.next_num) }}" class="page-link">ä¸‹ä¸€é¡µ &raquo;</a>
    {% endif %}
</div>
{% endif %}

{% elif query %}
<!-- æ— ç»“æœæç¤º -->
<div class="no-results">
    <div class="no-results-icon">ğŸ”</div>
    <h3>æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</h3>
    <p>å°è¯•ä»¥ä¸‹å»ºè®®ï¼š</p>
    <ul>
        <li>æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
        <li>å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</li>
        <li>ä½¿ç”¨æ›´ç®€å•çš„æœç´¢è¯</li>
        <li>å°è¯•æœç´¢"å…¨éƒ¨"è€Œä¸æ˜¯ä»…æ ‡é¢˜æˆ–å†…å®¹</li>
    </ul>
    <div class="no-results-actions">
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">æµè§ˆæ‰€æœ‰ä¸²</a>
        <a href="{{ url_for('main.new_thread') }}" class="btn btn-secondary">å‘æ–°ä¸²</a>
    </div>
</div>
{% endif %}

<!-- å›¾ç‰‡å¼¹çª— -->
<div id="imageModal" class="modal" onclick="hideImageModal()">
    <div class="modal-content">
        <img id="modalImage" src="" alt="å›¾ç‰‡">
        <span class="modal-close">&times;</span>
    </div>
</div>

<script>
// åœ¨æœç´¢ç»“æœé¡µé¢å°†ä¾§è¾¹æ æŒ‰é’®æ”¹ä¸ºè¿”å›æŒ‰é’®
document.addEventListener('DOMContentLoaded', () => {
    // è·å–ç§»åŠ¨ç«¯èœå•æŒ‰é’®
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    
    if (mobileMenuBtn && window.innerWidth <= 768) {
        // ä¿®æ”¹æŒ‰é’®æ ·å¼ä¸ºè¿”å›æŒ‰é’®
        mobileMenuBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
        
        // ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶å’Œç±»å
        mobileMenuBtn.removeAttribute('onclick');
        mobileMenuBtn.classList.remove('active');
        mobileMenuBtn.setAttribute('aria-label', 'è¿”å›');
        
        // æ·»åŠ è¿”å›åŠŸèƒ½
        mobileMenuBtn.addEventListener('click', () => {
            // ä¼˜å…ˆè¿”å›ä¸Šä¸€é¡µï¼Œå¦‚æœæ²¡æœ‰å†å²è®°å½•åˆ™è¿”å›é¦–é¡µ
            if (document.referrer && document.referrer !== window.location.href) {
                window.history.back();
            } else {
                window.location.href = "{{ url_for('main.index') }}";
            }
        });
        
        // ä¿®æ”¹æŒ‰é’®æ ·å¼å’Œæ·»åŠ ç±»å
        mobileMenuBtn.classList.add('back-btn');
        mobileMenuBtn.style.background = 'rgba(233, 76, 76, 0.9)';
        mobileMenuBtn.style.padding = '8px';
        mobileMenuBtn.style.width = '40px';
        mobileMenuBtn.style.height = '40px';
    }
});
</script>
{% endblock %} 