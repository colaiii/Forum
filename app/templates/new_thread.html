{% extends "base.html" %}

{% block title %}å‘æ–°ä¸² - æ ¡å›­ç½‘åŒ¿åè®ºå›{% endblock %}

{% block content %}
<div class="thread-nav">
    {% if current_category == 'timeline' %}
    <a href="{{ url_for('main.index') }}" class="btn btn-back">â¬… è¿”å›æ—¶é—´çº¿</a>
    {% else %}
    <a href="{{ url_for('main.index', category=current_category) }}" class="btn btn-back">â¬… è¿”å›{{ (categories|selectattr('0', 'equalto', current_category)|first|last).name if categories|selectattr('0', 'equalto', current_category)|first else 'æ¿å—' }}</a>
    {% endif %}
</div>

<div class="new-thread-section">
    <h2>ğŸ“ å‘è¡¨æ–°ä¸²</h2>
    
    <form id="newThreadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="threadCategory">é€‰æ‹©æ¿å—:</label>
            <select id="threadCategory" name="category" required>
                {% for category_key, category_data in categories %}
                {% if category_key != 'timeline' %}
                <option value="{{ category_key }}" 
                        {{ 'selected' if current_category == category_key else '' }}
                        style="color: {{ category_data.color }}">
                    {{ category_data.icon }} {{ category_data.name }} - {{ category_data.description }}
                </option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="threadTitle">æ ‡é¢˜:</label>
            <input type="text" id="threadTitle" name="title" maxlength="100" placeholder="è¾“å…¥ä¸²æ ‡é¢˜..." required>
            <div class="char-count">
                <span id="titleCount">0</span>/100
            </div>
        </div>
        
        <div class="form-group">
            <label for="threadContent">å†…å®¹:</label>
            <textarea id="threadContent" name="content" rows="10" placeholder="è¾“å…¥ä¸²å†…å®¹..." required></textarea>
        </div>
        
        <div class="form-group">
            <label for="threadImages">å›¾ç‰‡ (å¯é€‰):</label>
            <input type="file" id="threadImages" name="images" accept="image/*" multiple>
            <div class="file-info">æ”¯æŒ PNG, JPG, GIF, WebP æ ¼å¼ï¼Œæ¯å¼ æœ€å¤§ 16MBï¼Œæœ€å¤šå¯é€‰æ‹©5å¼ å›¾ç‰‡</div>
            <div class="image-preview" id="imagePreview"></div>
        </div>
        
        <div class="form-rules">
            <h4>ğŸ“‹ å‘ä¸²è§„åˆ™:</h4>
            <ul>
                <li>è¯·æ–‡æ˜å‘è¨€ï¼Œç¦æ­¢å‘å¸ƒè¿æ³•è¿è§„å†…å®¹</li>
                <li>ç¦æ­¢æ¶æ„çŒæ°´å’Œåˆ·å±</li>
                <li>å°Šé‡ä»–äººï¼Œç†æ€§è®¨è®º</li>
                <li>å›¾ç‰‡å†…å®¹è¯·ç¬¦åˆæ ¡å›­ç½‘è§„èŒƒ</li>
                <li>æœ¬è®ºå›ä¸ºåŒ¿åè®ºå›ï¼Œé€šè¿‡é¥¼å¹²ç³»ç»Ÿè¯†åˆ«ç”¨æˆ·</li>
                <li>è¯·é€‰æ‹©åˆé€‚çš„æ¿å—å‘è¡¨å†…å®¹</li>
            </ul>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">å‘è¡¨ä¸²</button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">å–æ¶ˆ</button>
        </div>
    </form>
</div>

<!-- å›¾ç‰‡é™åˆ¶æç¤ºå¼¹çª— -->
<div id="imageLimitModal" class="modal" onclick="hideImageLimitModal()">
    <div class="modal-content image-limit-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>âš ï¸ å›¾ç‰‡æ•°é‡é™åˆ¶</h2>
            <span class="modal-close" onclick="hideImageLimitModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="limit-message">
                <h3>æœ€å¤šåªèƒ½é€‰æ‹©5å¼ å›¾ç‰‡</h3>
                <p>æ‚¨å·²ç»é€‰æ‹©äº†å›¾ç‰‡ï¼Œæ— æ³•å†æ·»åŠ æ›´å¤šå›¾ç‰‡ã€‚</p>
                <div class="suggestions">
                    <h4>æ‚¨å¯ä»¥ï¼š</h4>
                    <ul>
                        <li>åˆ é™¤ä¸€äº›å·²é€‰æ‹©çš„å›¾ç‰‡åå†æ·»åŠ æ–°å›¾ç‰‡</li>
                        <li>è°ƒæ•´å›¾ç‰‡é€‰æ‹©ï¼Œä¿æŒåœ¨5å¼ ä»¥å†…</li>
                        <li>åˆ†å¤šæ¬¡å‘ä¸²æ¥åˆ†äº«æ›´å¤šå›¾ç‰‡</li>
                    </ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="hideImageLimitModal()">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸæç¤º -->
<div id="successMessage" class="message success" style="display: none;">
    <span id="successText">ä¸²å‘è¡¨æˆåŠŸï¼</span>
    <div class="success-actions">
        <a id="viewThreadLink" href="#" class="btn btn-primary btn-sm">æŸ¥çœ‹ä¸²</a>
        <button onclick="hideMessage('successMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
    </div>
</div>

<!-- é”™è¯¯æç¤º -->
<div id="errorMessage" class="message error" style="display: none;">
    <span id="errorText">å‘ç”Ÿé”™è¯¯</span>
    <button onclick="hideMessage('errorMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
</div>

<!-- åŠ è½½æç¤º -->
<div id="loadingMessage" class="message loading" style="display: none;">
    <span>ğŸš€ æ­£åœ¨å‘è¡¨ä¸²...</span>
</div>

<!-- é¢‘ç‡é™åˆ¶æç¤º -->
<div id="rateLimitMessage" class="message warning" style="display: none;">
    <span id="rateLimitText">å‘ä¸²é¢‘ç‡é™åˆ¶</span>
    <button onclick="hideMessage('rateLimitMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
</div>

<script>
// DOM å…ƒç´ 
const form = document.getElementById('newThreadForm');
const titleInput = document.getElementById('threadTitle');
const titleCount = document.getElementById('titleCount');
const contentTextarea = document.getElementById('threadContent');
const imageInput = document.getElementById('threadImages');
const imagePreview = document.getElementById('imagePreview');

// æ ‡é¢˜å­—ç¬¦è®¡æ•°
titleInput.addEventListener('input', function() {
    titleCount.textContent = this.value.length;
});

// å¤šå›¾ç‰‡é¢„è§ˆåŠŸèƒ½
let selectedFiles = new DataTransfer();

imageInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    
    // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶
    if (selectedFiles.files.length + files.length > 5) {
        showImageLimitModal();
        // é‡ç½®æ–‡ä»¶é€‰æ‹©å™¨ï¼Œä½†ä¿æŒå·²é€‰æ‹©çš„æ–‡ä»¶
        imageInput.files = selectedFiles.files;
        return;
    }
    
    files.forEach(file => {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 16 * 1024 * 1024) {
            showMessage('errorMessage', `å›¾ç‰‡ ${file.name} è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ16MB`);
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showMessage('errorMessage', `ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`);
            return;
        }
        
        // æ·»åŠ åˆ°é€‰ä¸­æ–‡ä»¶åˆ—è¡¨
        selectedFiles.items.add(file);
    });
    
    // æ›´æ–°inputçš„files
    imageInput.files = selectedFiles.files;
    
    // æ›´æ–°é¢„è§ˆ
    updateImagePreview();
});

function updateImagePreview() {
    imagePreview.innerHTML = '';
    
    const files = Array.from(selectedFiles.files);
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview-item';
            previewContainer.style.cssText = `
                display: flex;
                align-items: center;
                margin: 10px 0;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #f9f9f9;
                position: relative;
            `;
            
            const imgContainer = document.createElement('div');
            imgContainer.style.cssText = `
                position: relative;
                margin-right: 15px;
                flex-shrink: 0;
            `;
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.cssText = `
                max-width: 120px;
                max-height: 120px;
                border-radius: 4px;
                display: block;
            `;
            
            const infoDiv = document.createElement('div');
            infoDiv.style.flex = '1';
            infoDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${file.name}</div>
                <div style="color: #666; font-size: 0.9em;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
            `;
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.type = 'button';
            removeBtn.className = 'image-remove-btn';
            removeBtn.title = 'ç§»é™¤å›¾ç‰‡';
            removeBtn.onclick = function() {
                removeImage(index);
            };
            
            imgContainer.appendChild(img);
            imgContainer.appendChild(removeBtn);
            previewContainer.appendChild(imgContainer);
            previewContainer.appendChild(infoDiv);
            imagePreview.appendChild(previewContainer);
        };
        reader.readAsDataURL(file);
    });
    
    if (files.length === 0) {
        imagePreview.innerHTML = '<div style="color: #666; font-style: italic;">æš‚æœªé€‰æ‹©å›¾ç‰‡</div>';
    }
}

function removeImage(index) {
    const newFiles = new DataTransfer();
    const files = Array.from(selectedFiles.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            newFiles.items.add(file);
        }
    });
    
    selectedFiles = newFiles;
    imageInput.files = selectedFiles.files;
    updateImagePreview();
}

// åˆå§‹åŒ–é¢„è§ˆ
updateImagePreview();

// å›¾ç‰‡é™åˆ¶å¼¹çª—å‡½æ•°
function showImageLimitModal() {
    document.getElementById('imageLimitModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
}

function hideImageLimitModal() {
    document.getElementById('imageLimitModal').style.display = 'none';
    document.body.style.overflow = ''; // æ¢å¤æ»šåŠ¨
}

// è¡¨å•æäº¤
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showMessage('loadingMessage');
    
    try {
        const response = await fetch('/api/threads', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        hideMessage('loadingMessage');
        
        if (response.ok && result.success) {
            // æˆåŠŸ - ç›´æ¥è·³è½¬åˆ°ä¸²è¯¦æƒ…é¡µ
            window.location.href = `/thread/${result.thread_id}`;
            
        } else if (response.status === 429 && result.rate_limit) {
            // é¢‘ç‡é™åˆ¶
            showRateLimitMessage(result);
        } else {
            // å…¶ä»–é”™è¯¯
            showMessage('errorMessage', result.error || 'å‘è¡¨å¤±è´¥');
        }
        
    } catch (error) {
        hideMessage('loadingMessage');
        console.error('æäº¤é”™è¯¯:', error);
        showMessage('errorMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
    }
});

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(messageId, text = '') {
    // éšè—å…¶ä»–æ¶ˆæ¯
    hideAllMessages();
    
    const message = document.getElementById(messageId);
    if (text && messageId !== 'loadingMessage') {
        const textElement = message.querySelector('span');
        if (textElement) {
            textElement.textContent = text;
        }
    }
    message.style.display = 'block';
}

// éšè—æ¶ˆæ¯
function hideMessage(messageId) {
    document.getElementById(messageId).style.display = 'none';
}

// éšè—æ‰€æœ‰æ¶ˆæ¯
function hideAllMessages() {
    const messages = ['successMessage', 'errorMessage', 'loadingMessage', 'rateLimitMessage'];
    messages.forEach(id => hideMessage(id));
}

// æ˜¾ç¤ºé¢‘ç‡é™åˆ¶æ¶ˆæ¯
function showRateLimitMessage(rateLimitData) {
    document.getElementById('rateLimitText').textContent = rateLimitData.error || 'å‘ä¸²è¿‡äºé¢‘ç¹';
    showMessage('rateLimitMessage');
}

// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter æäº¤è¡¨å•
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
    }
});

// åœ¨å‘æ–°ä¸²é¡µé¢å°†ä¾§è¾¹æ æŒ‰é’®æ”¹ä¸ºè¿”å›æŒ‰é’®
document.addEventListener('DOMContentLoaded', () => {
    // è·å–ç§»åŠ¨ç«¯èœå•æŒ‰é’®
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    
    if (mobileMenuBtn && window.innerWidth <= 768) {
        // ä¿®æ”¹æŒ‰é’®æ ·å¼ä¸ºè¿”å›æŒ‰é’®
        mobileMenuBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
        
        // ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶å’Œç±»å
        mobileMenuBtn.removeAttribute('onclick');
        mobileMenuBtn.classList.remove('active');
        mobileMenuBtn.setAttribute('aria-label', 'è¿”å›');
        
        // æ·»åŠ è¿”å›åŠŸèƒ½
        mobileMenuBtn.addEventListener('click', () => {
            // æ ¹æ®å½“å‰åˆ†ç±»è¿”å›å¯¹åº”é¡µé¢
            {% if current_category == 'timeline' %}
                window.location.href = "{{ url_for('main.index') }}";
            {% else %}
                window.location.href = "{{ url_for('main.index', category=current_category) }}";
            {% endif %}
        });
        
        // ä¿®æ”¹æŒ‰é’®æ ·å¼å’Œæ·»åŠ ç±»å
        mobileMenuBtn.classList.add('back-btn');
        mobileMenuBtn.style.background = 'rgba(233, 76, 76, 0.9)';
        mobileMenuBtn.style.padding = '8px';
        mobileMenuBtn.style.width = '40px';
        mobileMenuBtn.style.height = '40px';
    }
});
</script>
{% endblock %} 