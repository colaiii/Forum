{% extends "base.html" %}

{% block title %}å‘æ–°ä¸² - æ ¡å›­ç½‘åŒ¿åè®ºå›{% endblock %}

{% block content %}
<div class="thread-nav">
    {% if current_category == 'timeline' %}
    <a href="{{ url_for('main.index') }}" class="btn btn-back">â¬… è¿”å›æ—¶é—´çº¿</a>
    {% else %}
    <a href="{{ url_for('main.index', category=current_category) }}" class="btn btn-back">â¬… è¿”å›{{ categories|selectattr('0', 'equalto', current_category)|first|last.name if categories|selectattr('0', 'equalto', current_category)|first else 'æ¿å—' }}</a>
    {% endif %}
</div>

<div class="new-thread-section">
    <h2>ğŸ“ å‘è¡¨æ–°ä¸²</h2>
    
    <form id="newThreadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="threadCategory">é€‰æ‹©æ¿å—:</label>
            <select id="threadCategory" name="category" required>
                {% for category_key, category_data in categories %}
                {% if category_key != 'timeline' %}
                <option value="{{ category_key }}" 
                        {{ 'selected' if current_category == category_key else '' }}
                        style="color: {{ category_data.color }}">
                    {{ category_data.icon }} {{ category_data.name }} - {{ category_data.description }}
                </option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="threadTitle">æ ‡é¢˜:</label>
            <input type="text" id="threadTitle" name="title" maxlength="100" placeholder="è¾“å…¥ä¸²æ ‡é¢˜..." required>
            <div class="char-count">
                <span id="titleCount">0</span>/100
            </div>
        </div>
        
        <div class="form-group">
            <label for="threadContent">å†…å®¹:</label>
            <textarea id="threadContent" name="content" rows="10" placeholder="è¾“å…¥ä¸²å†…å®¹..." required></textarea>
        </div>
        
        <div class="form-group">
            <label for="threadImage">å›¾ç‰‡ (å¯é€‰):</label>
            <input type="file" id="threadImage" name="image" accept="image/*">
            <div class="file-info">æ”¯æŒ PNG, JPG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§ 16MB</div>
            <div class="image-preview" id="imagePreview"></div>
        </div>
        
        <div class="form-rules">
            <h4>ğŸ“‹ å‘ä¸²è§„åˆ™:</h4>
            <ul>
                <li>è¯·æ–‡æ˜å‘è¨€ï¼Œç¦æ­¢å‘å¸ƒè¿æ³•è¿è§„å†…å®¹</li>
                <li>ç¦æ­¢æ¶æ„çŒæ°´å’Œåˆ·å±</li>
                <li>å°Šé‡ä»–äººï¼Œç†æ€§è®¨è®º</li>
                <li>å›¾ç‰‡å†…å®¹è¯·ç¬¦åˆæ ¡å›­ç½‘è§„èŒƒ</li>
                <li>æœ¬è®ºå›ä¸ºåŒ¿åè®ºå›ï¼Œé€šè¿‡é¥¼å¹²ç³»ç»Ÿè¯†åˆ«ç”¨æˆ·</li>
                <li>è¯·é€‰æ‹©åˆé€‚çš„æ¿å—å‘è¡¨å†…å®¹</li>
            </ul>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">å‘è¡¨ä¸²</button>
            <button type="button" class="btn btn-secondary" onclick="history.back()">å–æ¶ˆ</button>
        </div>
    </form>
</div>

<!-- æˆåŠŸæç¤º -->
<div id="successMessage" class="message success" style="display: none;">
    <span id="successText">ä¸²å‘è¡¨æˆåŠŸï¼</span>
    <div class="success-actions">
        <a id="viewThreadLink" href="#" class="btn btn-primary btn-sm">æŸ¥çœ‹ä¸²</a>
        <button onclick="hideMessage('successMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
    </div>
</div>

<!-- é”™è¯¯æç¤º -->
<div id="errorMessage" class="message error" style="display: none;">
    <span id="errorText">å‘ç”Ÿé”™è¯¯</span>
    <button onclick="hideMessage('errorMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
</div>

<!-- åŠ è½½æç¤º -->
<div id="loadingMessage" class="message loading" style="display: none;">
    <span>ğŸš€ æ­£åœ¨å‘è¡¨ä¸²...</span>
</div>

<!-- é¢‘ç‡é™åˆ¶æç¤º -->
<div id="rateLimitMessage" class="message warning" style="display: none;">
    <div id="rateLimitContent">
        <span id="rateLimitText">å‘ä¸²é¢‘ç‡é™åˆ¶</span>
        <div class="rate-limit-info">
            <div>å½“å‰å°è¯•æ¬¡æ•°: <span id="currentAttempts">0</span>/<span id="maxAttempts">3</span></div>
            <div>ç­‰å¾…æ—¶é—´: <span id="waitTime">0</span> ç§’</div>
        </div>
    </div>
    <button onclick="hideMessage('rateLimitMessage')" class="btn btn-secondary btn-sm">å…³é—­</button>
</div>

<script>
// DOM å…ƒç´ 
const form = document.getElementById('newThreadForm');
const titleInput = document.getElementById('threadTitle');
const titleCount = document.getElementById('titleCount');
const contentTextarea = document.getElementById('threadContent');
const imageInput = document.getElementById('threadImage');
const imagePreview = document.getElementById('imagePreview');

// æ ‡é¢˜å­—ç¬¦è®¡æ•°
titleInput.addEventListener('input', function() {
    titleCount.textContent = this.value.length;
});

// å›¾ç‰‡é¢„è§ˆ
imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    imagePreview.innerHTML = '';
    
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 16 * 1024 * 1024) {
            showMessage('errorMessage', 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ16MB');
            this.value = '';
            return;
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '300px';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '8px';
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'ç§»é™¤å›¾ç‰‡';
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-secondary';
            removeBtn.style.marginLeft = '10px';
            removeBtn.onclick = function() {
                imageInput.value = '';
                imagePreview.innerHTML = '';
            };
            
            const previewContainer = document.createElement('div');
            previewContainer.style.display = 'flex';
            previewContainer.style.alignItems = 'center';
            previewContainer.style.marginTop = '10px';
            previewContainer.appendChild(img);
            previewContainer.appendChild(removeBtn);
            
            imagePreview.appendChild(previewContainer);
        };
        reader.readAsDataURL(file);
    }
});

// è¡¨å•æäº¤
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showMessage('loadingMessage');
    
    try {
        const response = await fetch('/api/threads', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        hideMessage('loadingMessage');
        
        if (response.ok && result.success) {
            // æˆåŠŸ
            document.getElementById('successText').textContent = result.message || 'ä¸²å‘è¡¨æˆåŠŸï¼';
            document.getElementById('viewThreadLink').href = `/thread/${result.thread_id}`;
            showMessage('successMessage');
            
            // æ¸…ç©ºè¡¨å•
            form.reset();
            imagePreview.innerHTML = '';
            titleCount.textContent = '0';
            
        } else if (response.status === 429 && result.rate_limit) {
            // é¢‘ç‡é™åˆ¶
            showRateLimitMessage(result);
        } else {
            // å…¶ä»–é”™è¯¯
            showMessage('errorMessage', result.error || 'å‘è¡¨å¤±è´¥');
        }
        
    } catch (error) {
        hideMessage('loadingMessage');
        console.error('æäº¤é”™è¯¯:', error);
        showMessage('errorMessage', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
    }
});

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(messageId, text = '') {
    // éšè—å…¶ä»–æ¶ˆæ¯
    hideAllMessages();
    
    const message = document.getElementById(messageId);
    if (text && messageId !== 'loadingMessage') {
        const textElement = message.querySelector('span');
        if (textElement) {
            textElement.textContent = text;
        }
    }
    message.style.display = 'block';
}

// éšè—æ¶ˆæ¯
function hideMessage(messageId) {
    document.getElementById(messageId).style.display = 'none';
}

// éšè—æ‰€æœ‰æ¶ˆæ¯
function hideAllMessages() {
    const messages = ['successMessage', 'errorMessage', 'loadingMessage', 'rateLimitMessage'];
    messages.forEach(id => hideMessage(id));
}

// æ˜¾ç¤ºé¢‘ç‡é™åˆ¶æ¶ˆæ¯
function showRateLimitMessage(rateLimitData) {
    const message = document.getElementById('rateLimitMessage');
    document.getElementById('rateLimitText').textContent = rateLimitData.error || 'å‘ä¸²è¿‡äºé¢‘ç¹';
    document.getElementById('currentAttempts').textContent = rateLimitData.rate_limit.current_attempts;
    document.getElementById('maxAttempts').textContent = rateLimitData.rate_limit.max_attempts;
    document.getElementById('waitTime').textContent = rateLimitData.rate_limit.wait_time;
    
    showMessage('rateLimitMessage');
}

// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter æäº¤è¡¨å•
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
    }
});

// åœ¨å‘æ–°ä¸²é¡µé¢å°†ä¾§è¾¹æ æŒ‰é’®æ”¹ä¸ºè¿”å›æŒ‰é’®
document.addEventListener('DOMContentLoaded', () => {
    // è·å–ç§»åŠ¨ç«¯èœå•æŒ‰é’®
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    
    if (mobileMenuBtn && window.innerWidth <= 768) {
        // ä¿®æ”¹æŒ‰é’®æ ·å¼ä¸ºè¿”å›æŒ‰é’®
        mobileMenuBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 19L5 12L12 5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
        
        // ç§»é™¤åŸæœ‰çš„ç‚¹å‡»äº‹ä»¶å’Œç±»å
        mobileMenuBtn.removeAttribute('onclick');
        mobileMenuBtn.classList.remove('active');
        mobileMenuBtn.setAttribute('aria-label', 'è¿”å›');
        
        // æ·»åŠ è¿”å›åŠŸèƒ½
        mobileMenuBtn.addEventListener('click', () => {
            // æ ¹æ®å½“å‰åˆ†ç±»è¿”å›å¯¹åº”é¡µé¢
            {% if current_category == 'timeline' %}
                window.location.href = "{{ url_for('main.index') }}";
            {% else %}
                window.location.href = "{{ url_for('main.index', category=current_category) }}";
            {% endif %}
        });
        
        // ä¿®æ”¹æŒ‰é’®æ ·å¼å’Œæ·»åŠ ç±»å
        mobileMenuBtn.classList.add('back-btn');
        mobileMenuBtn.style.background = 'rgba(233, 76, 76, 0.9)';
        mobileMenuBtn.style.padding = '8px';
        mobileMenuBtn.style.width = '40px';
        mobileMenuBtn.style.height = '40px';
    }
});
</script>
{% endblock %} 