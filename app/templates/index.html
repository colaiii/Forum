{% extends "base.html" %}

{% block title %}首页 - 校园网匿名论坛{% endblock %}

{% block content %}
<div class="forum-header">
    <h2>🏠 论坛首页</h2>
    <a href="{{ url_for('main.new_thread') }}" class="btn btn-primary">+ 发新串</a>
</div>

<!-- 搜索功能 -->
<div class="search-section">
    <form action="{{ url_for('main.search') }}" method="GET" class="search-form">
        <div class="search-input-wrapper">
            <input type="text" name="q" value="{{ request.args.get('q', '') }}" 
                   placeholder="搜索串标题、内容..." class="search-input" required>
            <button type="submit" class="search-btn">🔍 搜索</button>
        </div>
        <div class="search-options">
            <label class="search-option">
                <input type="radio" name="type" value="all" {{ 'checked' if request.args.get('type', 'all') == 'all' else '' }}>
                <span>全部</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="title" {{ 'checked' if request.args.get('type') == 'title' else '' }}>
                <span>仅标题</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="content" {{ 'checked' if request.args.get('type') == 'content' else '' }}>
                <span>仅内容</span>
            </label>
        </div>
    </form>
</div>

<!-- 自动刷新状态提示 -->
<div id="refreshStatus" class="refresh-status" style="display: none;">
    <span id="refreshMessage">🔄 正在检查新内容...</span>
</div>

<!-- 新串提示 -->
<div id="newThreadsNotification" class="new-threads-notification" style="display: none;">
    <span id="newThreadsMessage">📨 发现新串，点击刷新查看</span>
    <button onclick="refreshThreads(true)" class="refresh-btn">立即查看</button>
</div>

<!-- 置顶串 -->
{% if pinned_threads %}
<div class="pinned-section" id="pinnedSection">
    <h3 class="section-title">📌 置顶串</h3>
    <div id="pinnedThreadsList">
    {% for thread in pinned_threads %}
    <div class="thread-item pinned">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
            <span class="thread-pin">📌</span>
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.image_url %}
            <div class="thread-image">
                <img src="{{ thread.image_url }}" alt="图片" onclick="showImageModal(this.src)">
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">💬 {{ thread.reply_count }}</span>
            <span class="last-reply">最后回复: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<!-- 普通串列表 -->
<div class="threads-section">
    <h3 class="section-title">📝 最新串</h3>
    
    <div id="normalThreadsList">
    {% for thread in threads.items %}
    <div class="thread-item">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.image_url %}
            <div class="thread-image">
                <img src="{{ thread.image_url }}" alt="图片" onclick="showImageModal(this.src)">
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">💬 {{ thread.reply_count }}</span>
            <span class="last-reply">最后回复: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
</div>

<!-- 分页 -->
{% if threads.pages > 1 %}
<div class="pagination">
    {% if threads.has_prev %}
        <a href="{{ url_for('main.index', page=threads.prev_num) }}" class="page-link">&laquo; 上一页</a>
    {% endif %}
    
    {% for page_num in threads.iter_pages() %}
        {% if page_num %}
            {% if page_num != threads.page %}
                <a href="{{ url_for('main.index', page=page_num) }}" class="page-link">{{ page_num }}</a>
            {% else %}
                <span class="page-link current">{{ page_num }}</span>
            {% endif %}
        {% else %}
            <span class="page-link">...</span>
        {% endif %}
    {% endfor %}
    
    {% if threads.has_next %}
        <a href="{{ url_for('main.index', page=threads.next_num) }}" class="page-link">下一页 &raquo;</a>
    {% endif %}
</div>
{% endif %}

<!-- 图片弹窗 -->
<div id="imageModal" class="modal" onclick="hideImageModal()">
    <div class="modal-content">
        <img id="modalImage" src="" alt="图片">
        <span class="modal-close">&times;</span>
    </div>
</div>

<!-- 自动刷新脚本 -->
<script>
// 自动刷新功能
class AutoRefresh {
    constructor() {
        this.refreshInterval = 30000; // 30秒检查一次
        // 使用当前页面所有串中的最大ID，避免排序不一致的问题
        {% if threads.items %}
        const threadIds = [{{ threads.items | map(attribute='id') | list | join(',') }}];
        this.lastThreadId = Math.max(...threadIds);
        {% else %}
        this.lastThreadId = 0;
        {% endif %}
        this.isRefreshing = false;
        this.isPageVisible = true;
        this.intervalId = null;
        
        this.init();
    }
    
    init() {
        // 只在首页第一页启用自动刷新
        const currentPage = {{ request.args.get('page', 1) }};
        if (currentPage > 1) {
            return;
        }
        
        // 页面可见性检测
        document.addEventListener('visibilitychange', () => {
            this.isPageVisible = !document.hidden;
            if (this.isPageVisible) {
                this.checkForNewThreads();
            }
        });
        
        // 启动定时检查
        this.startAutoRefresh();
    }
    
    startAutoRefresh() {
        this.intervalId = setInterval(() => {
            if (this.isPageVisible && !this.isRefreshing) {
                this.checkForNewThreads();
            }
        }, this.refreshInterval);
    }
    
    stopAutoRefresh() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
        }
    }
    
    async checkForNewThreads() {
        if (this.isRefreshing) return;
        
        this.isRefreshing = true;
        this.showStatus('🔄 检查新内容中...');
        
        try {
            const response = await fetch(`/api/threads/latest?last_id=${this.lastThreadId}`);
            const data = await response.json();
            
            if (data.success && data.has_new_content && data.normal_threads.length > 0) {
                this.showNewThreadsNotification(data.normal_threads.length);
                this.lastThreadId = data.latest_thread_id;
            }
            
            this.hideStatus();
        } catch (error) {
            console.error('检查新串失败:', error);
            this.showStatus('❌ 检查失败', 2000);
        } finally {
            this.isRefreshing = false;
        }
    }
    
    showStatus(message, timeout = 0) {
        const status = document.getElementById('refreshStatus');
        const messageEl = document.getElementById('refreshMessage');
        if (status && messageEl) {
            messageEl.textContent = message;
            status.style.display = 'block';
            
            if (timeout > 0) {
                setTimeout(() => this.hideStatus(), timeout);
            }
        }
    }
    
    hideStatus() {
        const status = document.getElementById('refreshStatus');
        if (status) {
            status.style.display = 'none';
        }
    }
    
    showNewThreadsNotification(count) {
        const notification = document.getElementById('newThreadsNotification');
        const message = document.getElementById('newThreadsMessage');
        if (notification && message) {
            message.textContent = `📨 发现 ${count} 个新串，点击刷新查看`;
            notification.style.display = 'block';
        }
    }
    
    hideNewThreadsNotification() {
        const notification = document.getElementById('newThreadsNotification');
        if (notification) {
            notification.style.display = 'none';
        }
    }
}

// 刷新串列表
async function refreshThreads(force = false) {
    const autoRefresh = window.autoRefresh;
    if (!autoRefresh) return;
    
    if (force) {
        autoRefresh.hideNewThreadsNotification();
        window.location.reload();
        return;
    }
    
    autoRefresh.checkForNewThreads();
}

// 初始化自动刷新
document.addEventListener('DOMContentLoaded', () => {
    window.autoRefresh = new AutoRefresh();
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', () => {
    if (window.autoRefresh) {
        window.autoRefresh.stopAutoRefresh();
    }
});
</script>
{% endblock %} 