{% extends "base.html" %}

{% block title %}
{% if current_category == 'timeline' %}
é¦–é¡µ - æ ¡å›­ç½‘åŒ¿åè®ºå›
{% else %}
{{ category_info.name }} - æ ¡å›­ç½‘åŒ¿åè®ºå›
{% endif %}
{% endblock %}

{% block content %}
<div class="forum-layout">
    <!-- å·¦ä¾§æ¿å—å¯¼èˆª -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>ğŸ›ï¸ è®ºå›æ¿å—</h3>
        </div>
        <nav class="category-nav">
            {% for category_key, category_data in categories %}
            <a href="{{ url_for('main.index', category=category_key) }}" 
               class="category-item category-{{ category_key }} {{ 'active' if current_category == category_key else '' }}"
               onclick="handleCategorySwitch(event, this)">
                <span class="category-icon">{{ category_data.icon }}</span>
                <div class="category-info">
                    <span class="category-name">{{ category_data.name }}</span>
                    <span class="category-desc">{{ category_data.description }}</span>
                </div>
            </a>
            {% endfor %}
        </nav>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="content-header">
            <div class="page-title">
                <h2>{{ category_info.icon }} {{ category_info.name }}</h2>
                <p class="page-description">{{ category_info.description }}</p>
            </div>
            <div class="header-actions">
                {% if current_category == 'timeline' %}
    <a href="{{ url_for('main.new_thread') }}" class="btn btn-primary">+ å‘æ–°ä¸²</a>
                {% else %}
                <a href="{{ url_for('main.new_thread', category=current_category) }}" class="btn btn-primary">+ å‘æ–°ä¸²</a>
                {% endif %}
            </div>
</div>

<!-- æœç´¢åŠŸèƒ½ -->
<div class="search-section">
    <form action="{{ url_for('main.search') }}" method="GET" class="search-form">
                <input type="hidden" name="category" value="{{ current_category }}">
        <div class="search-input-wrapper">
            <input type="text" name="q" value="{{ request.args.get('q', '') }}" 
                           placeholder="åœ¨{{ category_info.name }}ä¸­æœç´¢..." class="search-input" required>
            <button type="submit" class="search-btn">ğŸ” æœç´¢</button>
        </div>
        <div class="search-options">
            <label class="search-option">
                <input type="radio" name="type" value="all" {{ 'checked' if request.args.get('type', 'all') == 'all' else '' }}>
                <span>å…¨éƒ¨</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="title" {{ 'checked' if request.args.get('type') == 'title' else '' }}>
                <span>ä»…æ ‡é¢˜</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="content" {{ 'checked' if request.args.get('type') == 'content' else '' }}>
                <span>ä»…å†…å®¹</span>
            </label>
        </div>
    </form>
</div>

<!-- è‡ªåŠ¨åˆ·æ–°çŠ¶æ€æç¤º -->
<div id="refreshStatus" class="refresh-status" style="display: none;">
    <span id="refreshMessage">ğŸ”„ æ­£åœ¨æ£€æŸ¥æ–°å†…å®¹...</span>
</div>

<!-- æ–°ä¸²æç¤º -->
<div id="newThreadsNotification" class="new-threads-notification" style="display: none;">
    <span id="newThreadsMessage">ğŸ“¨ å‘ç°æ–°ä¸²ï¼Œç‚¹å‡»åˆ·æ–°æŸ¥çœ‹</span>
    <button onclick="refreshThreads(true)" class="refresh-btn">ç«‹å³æŸ¥çœ‹</button>
</div>

<!-- ç½®é¡¶ä¸² -->
{% if pinned_threads %}
<div class="pinned-section" id="pinnedSection">
    <h3 class="section-title">ğŸ“Œ ç½®é¡¶ä¸²</h3>
    <div id="pinnedThreadsList">
    {% for thread in pinned_threads %}
    <div class="thread-item pinned">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
            <span class="thread-pin">ğŸ“Œ</span>
                    {% if current_category == 'timeline' %}
                    <span class="thread-category" style="background-color: rgba(0, 123, 255, 0.1); color: #007bff;">
                        ğŸ“ {{ thread.category }}
                    </span>
                    {% endif %}
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.image_url %}
            <div class="thread-image">
                <img src="{{ thread.image_url }}" alt="å›¾ç‰‡" onclick="showImageModal(this.src)">
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">ğŸ’¬ {{ thread.reply_count }}</span>
            <span class="last-reply">æœ€åå›å¤: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<!-- æ™®é€šä¸²åˆ—è¡¨ -->
<div class="threads-section">
    <h3 class="section-title">ğŸ“ æœ€æ–°ä¸²</h3>
    
    <div id="normalThreadsList">
    {% for thread in threads.items %}
    <div class="thread-item">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
                    {% if current_category == 'timeline' %}
                    <span class="thread-category" style="background-color: rgba(0, 123, 255, 0.1); color: #007bff;">
                        ğŸ“ {{ thread.category }}
                    </span>
                    {% endif %}
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.image_url %}
            <div class="thread-image">
                <img src="{{ thread.image_url }}" alt="å›¾ç‰‡" onclick="showImageModal(this.src)">
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">ğŸ’¬ {{ thread.reply_count }}</span>
            <span class="last-reply">æœ€åå›å¤: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- åˆ†é¡µ -->
{% if threads.pages > 1 %}
<div class="pagination">
    {% if threads.has_prev %}
                    <a href="{{ url_for('main.index', category=current_category, page=threads.prev_num) }}" class="page-btn">Â« ä¸Šä¸€é¡µ</a>
    {% endif %}
    
    {% for page_num in threads.iter_pages() %}
        {% if page_num %}
            {% if page_num != threads.page %}
                            <a href="{{ url_for('main.index', category=current_category, page=page_num) }}" class="page-btn">{{ page_num }}</a>
            {% else %}
                            <span class="page-btn current">{{ page_num }}</span>
            {% endif %}
        {% else %}
                        <span class="page-btn">â€¦</span>
        {% endif %}
    {% endfor %}
    
    {% if threads.has_next %}
                    <a href="{{ url_for('main.index', category=current_category, page=threads.next_num) }}" class="page-btn">ä¸‹ä¸€é¡µ Â»</a>
    {% endif %}
</div>
{% endif %}
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="imageModal" class="modal" onclick="closeImageModal()">
    <div class="modal-content">
        <span class="close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>
</div>

<script>
// å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
function showImageModal(src) {
    document.getElementById('imageModal').style.display = 'block';
    document.getElementById('modalImage').src = src;
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
let lastRefreshTime = Date.now();
let refreshInterval;
let isRefreshing = false;

function showRefreshStatus(message) {
    const status = document.getElementById('refreshStatus');
    const messageEl = document.getElementById('refreshMessage');
    messageEl.textContent = message;
    status.style.display = 'block';
    
    setTimeout(() => {
        status.style.display = 'none';
    }, 3000);
}

function showNewThreadsNotification(count) {
    const notification = document.getElementById('newThreadsNotification');
    const messageEl = document.getElementById('newThreadsMessage');
    messageEl.textContent = `ğŸ“¨ å‘ç° ${count} æ¡æ–°ä¸²ï¼Œç‚¹å‡»åˆ·æ–°æŸ¥çœ‹`;
    notification.style.display = 'block';
}

function hideNewThreadsNotification() {
    document.getElementById('newThreadsNotification').style.display = 'none';
}

function checkForNewThreads() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    showRefreshStatus('ğŸ”„ æ­£åœ¨æ£€æŸ¥æ–°å†…å®¹...');
    
    const category = '{{ current_category }}';
    fetch(`/api/check-new-threads?category=${category}&since=${lastRefreshTime}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_new_threads) {
                showNewThreadsNotification(data.new_count);
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥æ–°ä¸²å¤±è´¥:', error);
            showRefreshStatus('âŒ æ£€æŸ¥å¤±è´¥');
        })
        .finally(() => {
            isRefreshing = false;
        });
}

function refreshThreads(force = false) {
    if (force) {
        hideNewThreadsNotification();
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°é¿å…å†²çª
        stopAutoRefresh();
        // æ·»åŠ loadingçŠ¶æ€ï¼Œå‡å°‘é—ªçƒæ„Ÿ
        showRefreshStatus('ğŸ”„ æ­£åœ¨åˆ·æ–°é¡µé¢...');
        // å»¶è¿Ÿåˆ·æ–°ï¼Œç»™ç”¨æˆ·è§†è§‰ç¼“å†²
        setTimeout(() => {
            window.location.reload();
        }, 300);
    } else {
        checkForNewThreads();
    }
}

// å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
function startAutoRefresh() {
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ–°ä¸²
    refreshInterval = setInterval(checkForNewThreads, 30000);
}

// åœæ­¢è‡ªåŠ¨åˆ·æ–°
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿå¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…ä¸é¡µé¢åŠ è½½å†²çª
    setTimeout(() => {
        startAutoRefresh();
    }, 1000);
    
    // é¡µé¢éšè—æ—¶åœæ­¢åˆ·æ–°ï¼Œæ˜¾ç¤ºæ—¶é‡æ–°å¼€å§‹
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            // å»¶è¿Ÿé‡å¯ï¼Œé¿å…ç«‹å³å†²çª
            setTimeout(() => {
                startAutoRefresh();
            }, 500);
        }
    });
    
    // é¡µé¢å¸è½½å‰åœæ­¢è‡ªåŠ¨åˆ·æ–°
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
});

// æŒ‰é”®å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    // Ctrl+R æˆ– F5 æ‰‹åŠ¨åˆ·æ–°
    if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
        e.preventDefault();
        refreshThreads(true);
    }
    // Ctrl+N æ–°å»ºä¸²
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        {% if current_category == 'timeline' %}
        window.location.href = "{{ url_for('main.new_thread') }}";
        {% else %}
        window.location.href = "{{ url_for('main.new_thread', category=current_category) }}";
        {% endif %}
    }
});

// å¤„ç†æ¿å—åˆ‡æ¢çš„å¹³æ»‘è¿‡æ¸¡
function handleCategorySwitch(event, element) {
    // åœæ­¢è‡ªåŠ¨åˆ·æ–°é¿å…å†²çª
    stopAutoRefresh();
    
    // æ·»åŠ åˆ‡æ¢çŠ¶æ€æŒ‡ç¤º
    const sidebar = document.querySelector('.sidebar');
    sidebar.style.opacity = '0.7';
    sidebar.style.pointerEvents = 'none';
    
    // æ˜¾ç¤ºåˆ‡æ¢çŠ¶æ€
    showRefreshStatus('ğŸ”„ æ­£åœ¨åˆ‡æ¢æ¿å—...');
    
    // å»¶è¿Ÿè·³è½¬ï¼Œç»™ç”¨æˆ·è§†è§‰ç¼“å†²
    setTimeout(() => {
        window.location.href = element.href;
    }, 150);
    
    // é˜»æ­¢é»˜è®¤é“¾æ¥è¡Œä¸º
    event.preventDefault();
    return false;
}

// é¡µé¢åŠ è½½æ—¶çš„å¹³æ»‘æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    // ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåå†æ˜¾ç¤ºå†…å®¹ï¼Œé¿å…FOUC
    setTimeout(() => {
        document.body.classList.add('loaded');
        const forumLayout = document.querySelector('.forum-layout');
        if (forumLayout) {
            forumLayout.classList.add('ready');
        }
        
        // ä¸ºsidebaræ·»åŠ åŠ è½½å®Œæˆçš„æ ‡è®°
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.style.opacity = '1';
            sidebar.style.pointerEvents = 'auto';
        }
    }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
});
</script>

<style>
/* é˜²æ­¢é¡µé¢åŠ è½½æ—¶é—ªçƒçš„å…³é”®æ ·å¼ */
body {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

body.loaded {
    opacity: 1;
}

/* é˜²æ­¢å†…å®¹æœªåŠ è½½æ—¶çš„å¸ƒå±€åç§» */
.forum-layout {
    visibility: hidden;
}

.forum-layout.ready {
    visibility: visible;
}

.forum-layout {
    display: flex;
    position: relative;
    min-height: 100vh;
}

.sidebar {
    position: fixed;
    left: 0;
    top: 80px; /* ç´§è´´headerï¼Œæ— é—´è· */
    bottom: 0;
    width: 280px;
    min-width: 280px;
    max-width: 280px;
    background: white;
    border-right: 1px solid #e0e0e0;
    padding: 20px;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    z-index: 1000;
    /* é˜²æ­¢è·³åŠ¨çš„å…³é”®å±æ€§ */
    contain: layout style;
    will-change: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
    /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
    transition: opacity 0.15s ease-in-out;
}

.sidebar-header {
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 20px;
}

.sidebar-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 600;
}

.category-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
    /* é˜²æ­¢è·³åŠ¨ */
    width: 100%;
    contain: layout;
}

.category-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-radius: 8px;
    text-decoration: none;
    color: #666;
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
    position: relative;
    /* é˜²æ­¢è·³åŠ¨çš„å…³é”®å±æ€§ */
    width: 100%;
    box-sizing: border-box;
    min-height: 60px;
    max-height: 60px;
    overflow: hidden;
}

.category-item:hover {
    background: rgba(0, 123, 255, 0.1);
    color: #333;
    transform: translateX(2px);
}

.category-item.active {
    background: rgba(0, 123, 255, 0.15);
    color: #007bff;
    border-left-color: #007bff;
    font-weight: 600;
}

/* ä¸ºæ¯ä¸ªæ¿å—å®šä¹‰å›ºå®šé¢œè‰²ï¼Œé¿å…åŠ¨æ€è®¡ç®— */
.category-timeline.active {
    border-left-color: #007bff;
    color: #007bff;
}

.category-academic.active {
    border-left-color: #28a745;
    color: #28a745;
}

.category-academic.active .category-name {
    color: #28a745;
}

.category-life.active {
    border-left-color: #fd7e14;
    color: #fd7e14;
}

.category-life.active .category-name {
    color: #fd7e14;
}

.category-game.active {
    border-left-color: #e83e8c;
    color: #e83e8c;
}

.category-game.active .category-name {
    color: #e83e8c;
}

.category-creative.active {
    border-left-color: #6f42c1;
    color: #6f42c1;
}

.category-creative.active .category-name {
    color: #6f42c1;
}

.category-item.active::before {
    content: '';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #007bff;
}

.category-icon {
    font-size: 20px;
    margin-right: 12px;
    min-width: 24px;
    max-width: 24px;
    width: 24px;
    height: 24px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.category-info {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.category-name {
    font-weight: 600;
    font-size: 14px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
    padding: 0;
}

.category-desc {
    font-size: 12px;
    opacity: 0.7;
    margin-top: 2px;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0;
}

.main-content {
    margin-left: 300px;
    margin-right: auto;
    padding: 20px;
    max-width: 900px;
    width: calc(100% - 300px);
    min-height: calc(100vh - 80px); /* å‡å»headeré«˜åº¦ */
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-top: 35px;
    margin-bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.page-title h2 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
    font-size: 24px;
}

.page-description {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.thread-category {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-right: 8px;
}

/* ç¡®ä¿å†…å®¹åŒºåŸŸä¸ä¼šè¢«ä¾§è¾¹æ é®æŒ¡ */
body {
    margin: 0;
    padding: 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
    .main-content {
        margin-left: 280px;
        margin-right: 20px;
        max-width: none;
        width: calc(100% - 300px);
    }
    
    .content-header {
        margin-top: 35px;
    }
}

@media (max-width: 768px) {
    .forum-layout {
        flex-direction: column;
        min-height: auto;
    }
    
    .sidebar {
        position: static;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        height: auto;
        overflow-y: visible;
        top: auto; /* ç§»åŠ¨è®¾å¤‡ä¸Šé‡ç½®topå€¼ */
    }
    
    .sidebar-header {
        border-bottom: none;
        margin-bottom: 15px;
        padding-bottom: 10px;
    }
    
    .category-nav {
        flex-direction: row;
        overflow-x: auto;
        gap: 12px;
        padding-bottom: 8px;
        scrollbar-width: thin;
    }
    
    .category-nav::-webkit-scrollbar {
        height: 4px;
    }
    
    .category-nav::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    .category-nav::-webkit-scrollbar-thumb {
        background: var(--primary-color, #007bff);
        border-radius: 2px;
    }
    
    .category-item {
        flex-shrink: 0;
        min-width: 140px;
        border-left: none;
        border-bottom: 4px solid transparent;
        transform: none;
    }
    
    .category-item:hover {
        transform: none;
    }
    
    .category-item.active {
        border-left: none;
        border-bottom-color: #007bff;
    }
    
    .category-item.active::before {
        display: none;
    }
    
    .main-content {
        margin-left: 0;
        margin-right: 0;
        width: 100%;
        max-width: none;
        padding: 20px 15px;
    }
    
    .content-header {
        padding: 15px;
        margin-top: 35px;
        margin-bottom: 15px;
    }
    
    .page-title h2 {
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .category-item {
        min-width: 120px;
        padding: 10px 12px;
    }
    
    .category-name {
        font-size: 13px;
    }
    
    .category-desc {
        font-size: 11px;
    }
    
    .main-content {
        padding: 15px 10px;
    }
}
</style>
{% endblock %} 