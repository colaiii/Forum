{% extends "base.html" %}

{% block title %}
{% if current_category == 'timeline' %}
首页 - 校园网匿名论坛
{% else %}
{{ category_info.name }} - 校园网匿名论坛
{% endif %}
{% endblock %}

{% block content %}
<!-- 移动端侧边栏遮罩层 -->
<div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

<div class="forum-layout">
    <!-- 左侧板块导航 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>🏛️ 论坛板块</h3>
        </div>
        <nav class="category-nav">
            {% for category_key, category_data in categories %}
            <a href="{{ url_for('main.index', category=category_key) }}" 
               class="category-item category-{{ category_key }} {{ 'active' if current_category == category_key else '' }}"
               data-category="{{ category_key }}">
                <span class="category-icon">{{ category_data.icon }}</span>
                <div class="category-info">
                    <span class="category-name">{{ category_data.name }}</span>
                    <span class="category-desc">{{ category_data.description }}</span>
                </div>
            </a>
            {% endfor %}
        </nav>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="content-header">
            <div class="page-title">
                <h2>{{ category_info.icon }} {{ category_info.name }}</h2>
                <p class="page-description">{{ category_info.description }}</p>
            </div>
            <div class="header-actions">
                {% if current_category == 'timeline' %}
    <a href="{{ url_for('main.new_thread') }}" class="btn btn-primary">+ 发新串</a>
                {% else %}
                <a href="{{ url_for('main.new_thread', category=current_category) }}" class="btn btn-primary">+ 发新串</a>
                {% endif %}
            </div>
</div>

<!-- 搜索功能 -->
<div class="search-section">
    <form action="{{ url_for('main.search') }}" method="GET" class="search-form">
                <input type="hidden" name="category" value="{{ current_category }}">
        <div class="search-input-wrapper">
            <input type="text" name="q" value="{{ request.args.get('q', '') }}" 
                           placeholder="在{{ category_info.name }}中搜索..." class="search-input" required>
            <button type="submit" class="search-btn">🔍 搜索</button>
        </div>
        <div class="search-options">
            <label class="search-option">
                <input type="radio" name="type" value="all" {{ 'checked' if request.args.get('type', 'all') == 'all' else '' }}>
                <span>全部</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="title" {{ 'checked' if request.args.get('type') == 'title' else '' }}>
                <span>仅标题</span>
            </label>
            <label class="search-option">
                <input type="radio" name="type" value="content" {{ 'checked' if request.args.get('type') == 'content' else '' }}>
                <span>仅内容</span>
            </label>
        </div>
    </form>
</div>

<!-- 自动刷新状态提示 -->
<div id="refreshStatus" class="refresh-status" style="display: none;">
    <span id="refreshMessage">🔄 正在检查新内容...</span>
</div>

<!-- 新串提示 -->
<div id="newThreadsNotification" class="new-threads-notification" style="display: none;">
    <span id="newThreadsMessage">📨 发现新串，点击刷新查看</span>
    <button onclick="refreshThreads(true)" class="refresh-btn">立即查看</button>
</div>

<!-- 置顶串 -->
{% if pinned_threads %}
<div class="pinned-section" id="pinnedSection">
    <h3 class="section-title">📌 置顶串</h3>
    <div id="pinnedThreadsList">
    {% for thread in pinned_threads %}
    <div class="thread-item pinned" onclick="goToThread({{ thread.id }})" style="cursor: pointer;">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
            <span class="thread-pin">📌</span>
                    {% if current_category == 'timeline' %}
                    <span class="thread-category" style="background-color: rgba(0, 123, 255, 0.1); color: #007bff;">
                        📝 {{ thread.category }}
                    </span>
                    {% endif %}
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}" onclick="event.stopPropagation();">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.get_image_urls() %}
            <div class="thread-images">
                {% for image_url in thread.get_image_urls()[:3] %}
                <div class="thread-image">
                    <img src="{{ image_url }}" alt="图片" onclick="event.stopPropagation(); showImageModal(this.src);">
                </div>
                {% endfor %}
                {% if thread.get_image_urls()|length > 3 %}
                <div class="more-images">+{{ thread.get_image_urls()|length - 3 }}张图片</div>
                {% endif %}
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">💬 {{ thread.reply_count }}</span>
            <span class="last-reply">最后回复: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

<!-- 普通串列表 -->
<div class="threads-section">
    <h3 class="section-title">📝 最新串</h3>
    
    <div id="normalThreadsList">
    {% for thread in threads.items %}
    <div class="thread-item" onclick="goToThread({{ thread.id }})" style="cursor: pointer;">
        <div class="thread-header">
            <span class="thread-id">No.{{ thread.id }}</span>
                    {% if current_category == 'timeline' %}
                    <span class="thread-category" style="background-color: rgba(0, 123, 255, 0.1); color: #007bff;">
                        📝 {{ thread.category }}
                    </span>
                    {% endif %}
            <span class="thread-cookie" style="color: {{ cookie_manager.get_cookie_color(thread.cookie_id) }}">
                {{ cookie_manager.format_cookie_display(thread.cookie_id) }}
            </span>
            <span class="thread-time">{{ thread.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </div>
        <h4 class="thread-title">
            <a href="{{ url_for('main.view_thread', thread_id=thread.id) }}" onclick="event.stopPropagation();">{{ thread.title }}</a>
        </h4>
        <div class="thread-content">
            {% if thread.get_image_urls() %}
            <div class="thread-images">
                {% for image_url in thread.get_image_urls()[:3] %}
                <div class="thread-image">
                    <img src="{{ image_url }}" alt="图片" onclick="event.stopPropagation(); showImageModal(this.src);">
                </div>
                {% endfor %}
                {% if thread.get_image_urls()|length > 3 %}
                <div class="more-images">+{{ thread.get_image_urls()|length - 3 }}张图片</div>
                {% endif %}
            </div>
            {% endif %}
            <div class="markdown-preview">{{ (thread.content[:200] + '...' if thread.content|length > 200 else thread.content)|markdown }}</div>
        </div>
        <div class="thread-stats">
            <span class="reply-count">💬 {{ thread.reply_count }}</span>
            <span class="last-reply">最后回复: {{ thread.last_reply_at.strftime('%m-%d %H:%M') }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 分页 -->
{% if threads.pages > 1 %}
<div class="pagination">
    {% if threads.has_prev %}
                    <a href="{{ url_for('main.index', category=current_category, page=threads.prev_num) }}" class="page-link">« 上一页</a>
    {% endif %}
    
    {% for page_num in threads.iter_pages() %}
        {% if page_num %}
            {% if page_num != threads.page %}
                            <a href="{{ url_for('main.index', category=current_category, page=page_num) }}" class="page-link">{{ page_num }}</a>
            {% else %}
                            <span class="page-link current">{{ page_num }}</span>
            {% endif %}
        {% else %}
                        <span class="page-link">…</span>
        {% endif %}
    {% endfor %}
    
    {% if threads.has_next %}
                    <a href="{{ url_for('main.index', category=current_category, page=threads.next_num) }}" class="page-link">下一页 »</a>
    {% endif %}
</div>
{% endif %}
        </div>
    </div>
</div>

<!-- 图片预览模态框 -->
<div id="imageModal" class="modal" onclick="closeImageModal()">
    <div class="modal-content">
        <span class="close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="预览图片">
    </div>
</div>

<script>
// 图片预览功能
function showImageModal(src) {
    document.getElementById('imageModal').style.display = 'block';
    document.getElementById('modalImage').src = src;
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// 跳转到串详情页的函数
function goToThread(threadId) {
    window.location.href = "{{ url_for('main.view_thread', thread_id=0) }}".replace('0', threadId);
}

// 自动刷新功能
let lastRefreshTime = Date.now();
let refreshInterval;
let isRefreshing = false;

function showRefreshStatus(message) {
    const status = document.getElementById('refreshStatus');
    const messageEl = document.getElementById('refreshMessage');
    messageEl.textContent = message;
    status.style.display = 'block';
    
    setTimeout(() => {
        status.style.display = 'none';
    }, 3000);
}

function showNewThreadsNotification(count) {
    const notification = document.getElementById('newThreadsNotification');
    const messageEl = document.getElementById('newThreadsMessage');
    messageEl.textContent = `📨 发现 ${count} 条新串，点击刷新查看`;
    notification.style.display = 'block';
}

function hideNewThreadsNotification() {
    document.getElementById('newThreadsNotification').style.display = 'none';
}

function checkForNewThreads() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    showRefreshStatus('🔄 正在检查新内容...');
    
    const category = '{{ current_category }}';
    fetch(`/api/check-new-threads?category=${category}&since=${lastRefreshTime}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_new_threads) {
                showNewThreadsNotification(data.new_count);
            }
        })
        .catch(error => {
            console.error('检查新串失败:', error);
            showRefreshStatus('❌ 检查失败');
        })
        .finally(() => {
            isRefreshing = false;
        });
}

function refreshThreads(force = false) {
    if (force) {
        hideNewThreadsNotification();
        // 停止自动刷新避免冲突
        stopAutoRefresh();
        // 添加loading状态，减少闪烁感
        showRefreshStatus('🔄 正在刷新页面...');
        // 延迟刷新，给用户视觉缓冲
        setTimeout(() => {
            window.location.reload();
        }, 300);
    } else {
        checkForNewThreads();
    }
}

// 启动自动刷新
function startAutoRefresh() {
    // 每30秒检查一次新串
    refreshInterval = setInterval(checkForNewThreads, 30000);
}

// 停止自动刷新
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// 页面加载完成后启动自动刷新
document.addEventListener('DOMContentLoaded', function() {
    // 延迟启动自动刷新，避免与页面加载冲突
    setTimeout(() => {
        startAutoRefresh();
    }, 1000);
    
    // 页面隐藏时停止刷新，显示时重新开始
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            // 延迟重启，避免立即冲突
            setTimeout(() => {
                startAutoRefresh();
            }, 500);
        }
    });
    
    // 页面卸载前停止自动刷新
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
});

// 按键快捷键
document.addEventListener('keydown', function(e) {
    // Ctrl+R 或 F5 手动刷新
    if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
        e.preventDefault();
        refreshThreads(true);
    }
    // Ctrl+N 新建串
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        {% if current_category == 'timeline' %}
        window.location.href = "{{ url_for('main.new_thread') }}";
        {% else %}
        window.location.href = "{{ url_for('main.new_thread', category=current_category) }}";
        {% endif %}
    }
});

// 处理板块切换的平滑过渡 - 现在由category-switch.js处理
function handleCategorySwitch(event, element) {
    // 这个函数现在由CategorySwitcher类处理，保留作为备用
    event.preventDefault();
    return false;
}

// 显示/隐藏分类加载状态
function showCategoryLoading(show) {
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (show) {
        // 添加加载效果
        sidebar.style.opacity = '0.7';
        sidebar.style.pointerEvents = 'none';
        mainContent.style.opacity = '0.7';
        showRefreshStatus('🔄 正在切换板块...');
    } else {
        // 移除加载效果
        sidebar.style.opacity = '1';
        sidebar.style.pointerEvents = 'auto';
        mainContent.style.opacity = '1';
    }
}

// 加载分类内容
async function loadCategoryContent(category) {
    try {
        const response = await fetch(`/api/threads/latest?category=${category}&page=1`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || '获取数据失败');
        }
        
        // 更新页面内容
        updatePageContent(data, category);
        
        return data;
    } catch (error) {
        console.error('加载分类内容失败:', error);
        throw error;
    }
}

// 更新页面内容
function updatePageContent(data, category) {
    // 获取分类信息
    const categoryInfo = getCategoryInfo(category);
    
    // 更新页面标题
    updatePageTitle(categoryInfo);
    
    // 更新置顶串列表
    updatePinnedThreads(data.pinned_threads, category);
    
    // 更新普通串列表
    updateNormalThreads(data.normal_threads, category);
    
    // 更新分页
    updatePagination(data.pagination, category);
    
    // 更新搜索表单
    updateSearchForm(category);
    
    // 更新侧边栏激活状态
    updateSidebarActiveState(category);
}

// 获取分类信息
function getCategoryInfo(category) {
    const categories = {
        'timeline': { icon: '🏠', name: '首页', description: '最新的串和讨论' },
        'academic': { icon: '📚', name: '学术版', description: '学习、研究和学术讨论' },
        'life': { icon: '🌟', name: '生活版', description: '日常生活、分享和交流' },
        'game': { icon: '🎮', name: '游戏版', description: '游戏相关的讨论和分享' },
        'creative': { icon: '🎨', name: '创意版', description: '创意作品和艺术分享' }
    };
    return categories[category] || categories['timeline'];
}

// 更新页面标题
function updatePageTitle(categoryInfo) {
    const pageTitle = document.querySelector('.page-title h2');
    const pageDescription = document.querySelector('.page-description');
    
    if (pageTitle) {
        pageTitle.textContent = `${categoryInfo.icon} ${categoryInfo.name}`;
    }
    if (pageDescription) {
        pageDescription.textContent = categoryInfo.description;
    }
}

// 更新置顶串列表
function updatePinnedThreads(pinnedThreads, currentCategory) {
    const pinnedSection = document.getElementById('pinnedSection');
    const pinnedList = document.getElementById('pinnedThreadsList');
    
    if (pinnedThreads.length === 0) {
        if (pinnedSection) {
            pinnedSection.style.display = 'none';
        }
        return;
    }
    
    if (pinnedSection) {
        pinnedSection.style.display = 'block';
    }
    
    if (pinnedList) {
        pinnedList.innerHTML = pinnedThreads.map(thread => 
            generateThreadHTML(thread, currentCategory, true)
        ).join('');
    }
}

// 更新普通串列表
function updateNormalThreads(normalThreads, currentCategory) {
    const normalList = document.getElementById('normalThreadsList');
    
    if (normalList) {
        normalList.innerHTML = normalThreads.map(thread => 
            generateThreadHTML(thread, currentCategory, false)
        ).join('');
    }
}

// 生成串的HTML
function generateThreadHTML(thread, currentCategory, isPinned) {
    const categoryTag = currentCategory === 'timeline' ? 
        `<span class="thread-category" style="background-color: rgba(0, 123, 255, 0.1); color: #007bff;">
            📝 ${thread.category}
        </span>` : '';
    
    const pinIcon = isPinned ? '<span class="thread-pin">📌</span>' : '';
    
    const imagesHtml = thread.image_urls && thread.image_urls.length > 0 ? `
        <div class="thread-images">
            ${thread.image_urls.slice(0, 3).map(url => `
                <div class="thread-image">
                    <img src="${url}" alt="图片" onclick="event.stopPropagation(); showImageModal('${url}');">
                </div>
            `).join('')}
            ${thread.image_urls.length > 3 ? `
                <div class="more-images">+${thread.image_urls.length - 3}张图片</div>
            ` : ''}
        </div>
    ` : '';
    
    return `
        <div class="thread-item ${isPinned ? 'pinned' : ''}" onclick="goToThread(${thread.id})" style="cursor: pointer;">
            <div class="thread-header">
                <span class="thread-id">No.${thread.id}</span>
                ${pinIcon}
                ${categoryTag}
                <span class="thread-cookie" style="color: ${thread.cookie_color}">
                    ${thread.cookie_display}
                </span>
                <span class="thread-time">${thread.created_at}</span>
            </div>
            <h4 class="thread-title">
                <a href="/thread/${thread.id}" onclick="event.stopPropagation();">${thread.title}</a>
            </h4>
            <div class="thread-content">
                ${imagesHtml}
                <div class="markdown-preview">${thread.content}</div>
            </div>
            <div class="thread-stats">
                <span class="reply-count">💬 ${thread.reply_count}</span>
                <span class="last-reply">最后回复: ${thread.last_reply_at}</span>
            </div>
        </div>
    `;
}

// 更新分页
function updatePagination(pagination, category) {
    const paginationContainer = document.querySelector('.pagination');
    
    if (!paginationContainer || pagination.total_pages <= 1) {
        if (paginationContainer) {
            paginationContainer.style.display = 'none';
        }
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    let paginationHTML = '';
    
    // 上一页
    if (pagination.has_prev) {
        const prevUrl = category === 'timeline' ? 
            `/?page=${pagination.prev_num}` : 
            `/category/${category}?page=${pagination.prev_num}`;
        paginationHTML += `<a href="${prevUrl}" class="page-link" onclick="return handlePageClick(event, ${pagination.prev_num}, '${category}')">« 上一页</a>`;
    }
    
    // 页码
    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.current_page) {
            paginationHTML += `<span class="page-link current">${i}</span>`;
        } else {
            const pageUrl = category === 'timeline' ? 
                `/?page=${i}` : 
                `/category/${category}?page=${i}`;
            paginationHTML += `<a href="${pageUrl}" class="page-link" onclick="return handlePageClick(event, ${i}, '${category}')">${i}</a>`;
        }
    }
    
    // 下一页
    if (pagination.has_next) {
        const nextUrl = category === 'timeline' ? 
            `/?page=${pagination.next_num}` : 
            `/category/${category}?page=${pagination.next_num}`;
        paginationHTML += `<a href="${nextUrl}" class="page-link" onclick="return handlePageClick(event, ${pagination.next_num}, '${category}')">下一页 »</a>`;
    }
    
    paginationContainer.innerHTML = paginationHTML;
}

// 处理分页点击
function handlePageClick(event, page, category) {
    event.preventDefault();
    
    showCategoryLoading(true);
    
    loadCategoryPage(category, page)
        .then(() => {
            // 更新URL
            const newUrl = category === 'timeline' ? 
                `/?page=${page}` : 
                `/category/${category}?page=${page}`;
            history.pushState({category: category, page: page}, '', newUrl);
            
            showCategoryLoading(false);
            
            // 滚动到顶部
            window.scrollTo(0, 0);
        })
        .catch(error => {
            console.error('加载页面失败:', error);
            showRefreshStatus('❌ 加载页面失败');
            showCategoryLoading(false);
        });
    
    return false;
}

// 加载分类的指定页面
async function loadCategoryPage(category, page) {
    try {
        const response = await fetch(`/api/threads/latest?category=${category}&page=${page}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || '获取数据失败');
        }
        
        // 只更新内容区域，不更新标题和侧边栏
        updatePinnedThreads(data.pinned_threads, category);
        updateNormalThreads(data.normal_threads, category);
        updatePagination(data.pagination, category);
        
        return data;
    } catch (error) {
        console.error('加载分类页面失败:', error);
        throw error;
    }
}

// 更新搜索表单
function updateSearchForm(category) {
    const categoryInput = document.querySelector('input[name="category"]');
    const searchInput = document.querySelector('.search-input');
    
    if (categoryInput) {
        categoryInput.value = category;
    }
    
    if (searchInput) {
        const categoryInfo = getCategoryInfo(category);
        searchInput.placeholder = `在${categoryInfo.name}中搜索...`;
    }
}

// 更新侧边栏激活状态
function updateSidebarActiveState(category) {
    // 移除所有激活状态
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // 添加新的激活状态
    const activeItem = document.querySelector(`.category-item.category-${category}`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

// 更新当前分类（全局变量）
function updateCurrentCategory(category) {
    // 这里可以添加全局状态更新逻辑
    window.currentCategory = category;
}

// 处理浏览器前进后退
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.category) {
        const category = event.state.category;
        const page = event.state.page || 1;
        
        showCategoryLoading(true);
        
        if (page === 1) {
            loadCategoryContent(category).then(() => {
                updateCurrentCategory(category);
                showCategoryLoading(false);
            });
        } else {
            loadCategoryPage(category, page).then(() => {
                updateCurrentCategory(category);
                showCategoryLoading(false);
            });
        }
    }
});

// 移动端侧边栏控制函数
function toggleMobileSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    
    if (sidebar && overlay && menuBtn) {
        const isOpen = sidebar.classList.contains('mobile-open');
        
        if (isOpen) {
            closeMobileSidebar();
        } else {
            openMobileSidebar();
        }
    }
}

function openMobileSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    
    if (sidebar && overlay && menuBtn) {
        sidebar.classList.add('mobile-open');
        overlay.style.display = 'block';
        menuBtn.classList.add('active');
        document.body.style.overflow = 'hidden'; // 防止背景滚动
        
        // 延迟显示遮罩层的透明度动画
        setTimeout(() => {
            overlay.classList.add('active');
        }, 10);
    }
}

function closeMobileSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    
    if (sidebar && overlay && menuBtn) {
        sidebar.classList.remove('mobile-open');
        overlay.classList.remove('active');
        menuBtn.classList.remove('active');
        document.body.style.overflow = ''; // 恢复滚动
        
        // 延迟隐藏遮罩层
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }
}

// 页面加载时的平滑显示
document.addEventListener('DOMContentLoaded', function() {
    // 确保页面加载完成后再显示内容，避免FOUC
    setTimeout(() => {
        document.body.classList.add('loaded');
        const forumLayout = document.querySelector('.forum-layout');
        if (forumLayout) {
            forumLayout.classList.add('ready');
        }
        
        // 为sidebar添加加载完成的标记
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.style.opacity = '1';
            sidebar.style.pointerEvents = 'auto';
        }
    }, 100); // 短暂延迟确保所有资源加载完成
    
    // 监听窗口大小变化，在桌面端自动关闭移动端侧边栏
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            closeMobileSidebar();
        }
    });
});
</script>

<style>
/* 防止页面加载时闪烁的关键样式 */
body {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

body.loaded {
    opacity: 1;
}

/* 防止内容未加载时的布局偏移 */
.forum-layout {
    visibility: hidden;
}

.forum-layout.ready {
    visibility: visible;
}

.forum-layout {
    display: flex;
    position: relative;
    min-height: 100vh;
}

.sidebar {
    position: fixed;
    left: 0;
    top: 75px; /* 适应收窄后的header */
    bottom: 0;
    width: 280px;
    min-width: 280px;
    max-width: 280px;
    padding: 20px;
    overflow-y: auto;
    z-index: 1000;
    /* 防止跳动的关键属性 */
    contain: layout style;
    will-change: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
}

.sidebar-header {
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 20px;
}

.sidebar-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 18px;
    font-weight: 600;
}

.category-nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
    /* 防止跳动 */
    width: 100%;
    contain: layout;
}

.category-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-radius: 8px;
    text-decoration: none;
    color: #666;
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
    position: relative;
    /* 防止跳动的关键属性 */
    width: 100%;
    box-sizing: border-box;
    min-height: 60px;
    max-height: 60px;
    overflow: hidden;
}

.category-item:hover {
    background: rgba(0, 123, 255, 0.1);
    color: #333;
    transform: translateX(2px);
}

.category-item.active {
    background: rgba(0, 123, 255, 0.15);
    color: #007bff;
    border-left-color: #007bff;
    font-weight: 600;
}

/* 为每个板块定义固定颜色，避免动态计算 */
.category-timeline.active {
    border-left-color: #007bff;
    color: #007bff;
}

.category-academic.active {
    border-left-color: #28a745;
    color: #28a745;
}

.category-academic.active .category-name {
    color: #28a745;
}

.category-life.active {
    border-left-color: #fd7e14;
    color: #fd7e14;
}

.category-life.active .category-name {
    color: #fd7e14;
}

.category-game.active {
    border-left-color: #e83e8c;
    color: #e83e8c;
}

.category-game.active .category-name {
    color: #e83e8c;
}

.category-creative.active {
    border-left-color: #6f42c1;
    color: #6f42c1;
}

.category-creative.active .category-name {
    color: #6f42c1;
}

.category-item.active::before {
    content: '';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #007bff;
}

.category-icon {
    font-size: 20px;
    margin-right: 12px;
    min-width: 24px;
    max-width: 24px;
    width: 24px;
    height: 24px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.category-info {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.category-name {
    font-weight: 600;
    font-size: 14px;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
    padding: 0;
}

.category-desc {
    font-size: 12px;
    opacity: 0.7;
    margin-top: 2px;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0;
}

.main-content {
    margin-left: 300px;
    margin-right: auto;
    padding: 20px;
    max-width: 900px;
    width: calc(100% - 300px);
    min-height: calc(100vh - 80px); /* 减去header高度 */
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-top: 35px;
    margin-bottom: 20px;
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow-primary);
    border: 1px solid var(--border-primary);
    transition: all 0.3s ease;
}

.page-title h2 {
    margin: 0 0 5px 0;
    color: var(--text-primary);
    font-size: 24px;
}

.page-description {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
}

.header-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.thread-category {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-right: 8px;
}

/* 确保内容区域不会被侧边栏遮挡 */
body {
    margin: 0;
    padding: 0;
}

/* 响应式设计 */
@media (max-width: 1024px) {
    .main-content {
        margin-left: 280px;
        margin-right: 20px;
        max-width: none;
        width: calc(100% - 300px);
    }
    
    .content-header {
        margin-top: 35px;
    }
}

@media (max-width: 768px) {
    .forum-layout {
        flex-direction: column;
        min-height: auto;
    }
    
    .sidebar {
        position: fixed;
        left: -100%; /* 默认隐藏在左侧 */
        top: 70px; /* 与新的header高度对齐 */
        bottom: 0;
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-primary);
        box-shadow: 2px 0 20px var(--shadow-primary);
        z-index: 1600;
        transform: translateX(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        padding: 20px;
    }
    
    /* 侧边栏显示状态 */
    .sidebar.mobile-open {
        left: 0;
        transform: translateX(0);
    }
    
    .sidebar-header {
        border-bottom: none;
        margin-bottom: 15px;
        padding-bottom: 10px;
    }
    
    .category-nav {
        flex-direction: column;
        overflow-x: visible;
        overflow-y: auto;
        gap: 6px;
        padding-bottom: 0;
    }
    
    .category-nav::-webkit-scrollbar {
        height: 4px;
    }
    
    .category-nav::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    .category-nav::-webkit-scrollbar-thumb {
        background: var(--primary-color, #007bff);
        border-radius: 2px;
    }
    
    .category-item {
        flex-shrink: 0;
        min-width: auto;
        width: 100%;
        border-left: 4px solid transparent;
        border-bottom: none;
        transform: none;
    }
    
    .category-item:hover {
        transform: none;
    }
    
    .category-item.active {
        border-left-color: #007bff;
        border-bottom: none;
    }
    
    .category-item.active::before {
        display: none;
    }
    
    .main-content {
        margin-left: 0;
        margin-right: 0;
        width: 100%;
        max-width: none;
        padding: 20px 15px;
    }
    
    .content-header {
        padding: 15px;
        margin-top: 35px;
        margin-bottom: 15px;
    }
    
    .page-title h2 {
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .category-item {
        min-width: 120px;
        padding: 10px 12px;
    }
    
    .category-name {
        font-size: 13px;
    }
    
    .category-desc {
        font-size: 11px;
    }
    
    .main-content {
        padding: 15px 10px;
    }
}
</style>
{% endblock %} 